# Example Prometheus alert rules for Paket A (Option B Lead API)
#
# This file is intentionally minimal and should be adapted to your environment
# (job/instance labels, routing, notification channels).
#
# Notes:
# - The Lead API can attach trace exemplars (trace_id) to HTTP duration histograms.
#   To see exemplars, scrape /metrics with OpenMetrics enabled (Prometheus will usually
#   negotiate this automatically via Accept headers).

groups:
  - name: paket-a-lead-api
    rules:
      # Paket A ยง7 "Alerting (minimal)": error rate > 1% for 5 minutes
      - alert: LeadAPIHighErrorRate
        expr: |
          (
            sum(rate(lead_api_http_requests_total{route="/api/v1/leads",status_class="5xx"}[5m]))
            /
            sum(rate(lead_api_http_requests_total{route="/api/v1/leads"}[5m]))
          ) > 0.01
        for: 5m
        labels:
          severity: sev1
        annotations:
          summary: "Lead API 5xx error rate > 1% (5m)"
          description: "Lead submit endpoint (/api/v1/leads) is erroring at >1% for 5 minutes. Consider rollback if recent deploy."

      # Paket A ยง7 "Alerting (minimal)": lead submit endpoint failing continuously
      - alert: LeadAPISubmitFailingContinuously
        expr: |
          sum(rate(lead_api_http_requests_total{route="/api/v1/leads",status_class="5xx"}[2m])) > 0
          and
          sum(rate(lead_api_http_requests_total{route="/api/v1/leads"}[2m])) > 0
        for: 10m
        labels:
          severity: sev1
        annotations:
          summary: "Lead submit endpoint failing continuously"
          description: "Non-zero 5xx rate on /api/v1/leads sustained for 10 minutes."

      # Ops health: outbox backlog is ready-but-stuck
      - alert: LeadNotificationBacklogStuck
        expr: |
          lead_api_lead_notifications_pending_ready_total > 0
          and
          lead_api_lead_notifications_oldest_ready_pending_age_seconds > 600
        for: 10m
        labels:
          severity: sev2
        annotations:
          summary: "Lead notification backlog stuck (ready pending > 10m)"
          description: "Outbox has ready-to-send items older than 10 minutes. Check worker/senders and provider health."

      # Latency (alertability): p95 duration of /api/v1/leads is too slow.
      # Use route label (stable template) to avoid cardinality blow-up.
      - alert: LeadAPISlowP95
        expr: |
          histogram_quantile(
            0.95,
            sum(rate(lead_api_http_request_duration_seconds_bucket{route="/api/v1/leads"}[5m])) by (le)
          ) > 1
        for: 10m
        labels:
          severity: sev2
        annotations:
          summary: "Lead API p95 latency > 1s (10m)"
          description: "p95 request latency for /api/v1/leads exceeded 1s for 10 minutes. Use exemplars (trace_id) to drill down to representative slow requests."

      # Business failure mode: internal errors on lead submissions should be near-zero.
      - alert: LeadAPIInternalLeadFailures
        expr: |
          sum(rate(lead_api_lead_submissions_total{result="internal"}[5m])) > 0
        for: 5m
        labels:
          severity: sev2
        annotations:
          summary: "Lead submissions returning internal result"
          description: "Lead pipeline is recording internal failures. Investigate logs around http_request + lead_notification_enqueue_failed events."
